{% extends "base.html" %}

{% block title %}API调用日志{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2>API调用日志</h2>
    
    <!-- 统计信息 -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>统计信息</h5>
                </div>
                <div class="card-body" id="statsContainer">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 过滤器 -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h6>过滤条件</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="configFilter" class="form-label">接口配置</label>
                            <select class="form-select" id="configFilter">
                                <option value="">全部</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="startDate" class="form-label">开始日期</label>
                            <input type="datetime-local" class="form-control" id="startDate">
                        </div>
                        <div class="col-md-3">
                            <label for="endDate" class="form-label">结束日期</label>
                            <input type="datetime-local" class="form-control" id="endDate">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button class="btn btn-primary" onclick="loadLogs()">查询</button>
                                <button class="btn btn-secondary" onclick="resetFilters()">重置</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 日志列表 -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>调用记录</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadLogs()">刷新</button>
                </div>
                <div class="card-body">
                    <div id="logsContainer">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 分页 -->
                    <nav aria-label="日志分页" class="mt-3">
                        <ul class="pagination justify-content-center" id="pagination">
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 0;
const pageSize = 20;

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    loadConfigs();
    loadStats();
    loadLogs();
});

// 加载配置列表
function loadConfigs() {
    fetch('/api/configs')
    .then(response => response.json())
    .then(configs => {
        const select = document.getElementById('configFilter');
        select.innerHTML = '<option value="">全部</option>';
        
        Object.keys(configs).forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            select.appendChild(option);
        });
    })
    .catch(error => console.error('加载配置失败:', error));
}

// 加载统计信息
function loadStats() {
    fetch('/api/logs/stats')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayStats(data.stats);
        } else {
            document.getElementById('statsContainer').innerHTML = '<div class="alert alert-warning">无法加载统计信息</div>';
        }
    })
    .catch(error => {
        console.error('加载统计信息失败:', error);
        document.getElementById('statsContainer').innerHTML = '<div class="alert alert-danger">加载统计信息失败</div>';
    });
}

// 显示统计信息
function displayStats(stats) {
    const html = `
        <div class="row text-center">
            <div class="col-md-3">
                <h4 class="text-primary">${stats.total_calls || 0}</h4>
                <p>总调用次数</p>
            </div>
            <div class="col-md-3">
                <h4 class="text-success">${stats.success_calls || 0}</h4>
                <p>成功调用</p>
            </div>
            <div class="col-md-3">
                <h4 class="text-danger">${stats.error_calls || 0}</h4>
                <p>失败调用</p>
            </div>
            <div class="col-md-3">
                <h4 class="text-info">${stats.success_rate || 0}%</h4>
                <p>成功率</p>
            </div>
        </div>
    `;
    document.getElementById('statsContainer').innerHTML = html;
}

// 加载日志
function loadLogs(page = 0) {
    currentPage = page;
    const params = new URLSearchParams({
        limit: pageSize,
        skip: page * pageSize
    });
    
    const configName = document.getElementById('configFilter').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (configName) params.append('config_name', configName);
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    fetch(`/api/logs?${params}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayLogs(data.logs);
            updatePagination(data.logs.length);
        } else {
            document.getElementById('logsContainer').innerHTML = '<div class="alert alert-warning">无法加载日志</div>';
        }
    })
    .catch(error => {
        console.error('加载日志失败:', error);
        document.getElementById('logsContainer').innerHTML = '<div class="alert alert-danger">加载日志失败</div>';
    });
}

// 显示日志
function displayLogs(logs) {
    if (logs.length === 0) {
        document.getElementById('logsContainer').innerHTML = '<div class="alert alert-info">暂无日志记录</div>';
        return;
    }
    
    const html = `
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>时间</th>
                        <th>接口</th>
                        <th>状态</th>
                        <th>执行时间</th>
                        <th>IP地址</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${logs.map(log => `
                        <tr>
                            <td>${new Date(log.timestamp).toLocaleString()}</td>
                            <td>${log.config_name}</td>
                            <td>
                                ${log.success ? 
                                    '<span class="badge bg-success">成功</span>' : 
                                    '<span class="badge bg-danger">失败</span>'
                                }
                            </td>
                            <td>${log.execution_time_ms ? log.execution_time_ms.toFixed(2) + 'ms' : '-'}</td>
                            <td>${log.ip_address || '-'}</td>
                            <td>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    document.getElementById('logsContainer').innerHTML = html;
}

// 更新分页
function updatePagination(currentCount) {
    const pagination = document.getElementById('pagination');
    const hasMore = currentCount === pageSize;
    
    let html = '';
    
    // 上一页
    if (currentPage > 0) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadLogs(${currentPage - 1})">上一页</a></li>`;
    }
    
    // 当前页
    html += `<li class="page-item active"><span class="page-link">${currentPage + 1}</span></li>`;
    
    // 下一页
    if (hasMore) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadLogs(${currentPage + 1})">下一页</a></li>`;
    }
    
    pagination.innerHTML = html;
}

// 显示日志详情
function showLogDetail(logId) {
    // 这里可以实现日志详情的模态框显示
    alert('日志详情功能待实现，日志ID: ' + logId);
}

// 重置过滤器
function resetFilters() {
    document.getElementById('configFilter').value = '';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    loadLogs(0);
}
</script>
{% endblock %}